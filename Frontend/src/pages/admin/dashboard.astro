---
// Admin Dashboard
import Layout from '../../layouts/Layout.astro';
import { apiService } from '../../lib/apiService';
import '../../css/admin.css';

const dashboardData = await apiService.getAdminDashboard();
const stats = dashboardData?.stats || { total_customers: 0, total_products: 0, total_orders: 0 };
const transactions = (dashboardData?.transactions || []) as any[];
---

<Layout title="Admin Dashboard - TUKO" isAdmin={true}>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav class="admin-menu">
        <a href="/admin/dashboard" class="menu-item active">
          <span>Beranda</span>
        </a>
        <a href="/admin/transaksi" class="menu-item">
          <span>Transaksi</span>
        </a>
        <a href="/admin/kasir" class="menu-item">
          <span>Kasir</span>
        </a>
        <a href="/admin/user" class="menu-item">
          <span>Pengguna</span>
        </a>
        <a href="/admin/product" class="menu-item">
          <span>Produk</span>
        </a>
        <a href="/admin/kategori" class="menu-item">
          <span>Kategori</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="logout-btn">
          <span>Keluar</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1>Dashboard</h1>
      </div>

      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon"><i data-feather="users"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalCustomers">0</div>
            <div class="stat-label">Total Pelanggan</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i data-feather="shopping-cart"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalProducts">0</div>
            <div class="stat-label">Jumlah Menu</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i data-feather="file-text"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalOrders">0</div>
            <div class="stat-label">Total Order</div>
          </div>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="transactions-section">
        <h2 class="section-title">Transaksi Terakhir</h2>
        <div class="table-scroll-wrapper">
          <div class="table-container">
            <div class="table-header dashboard-grid">
              <div class="col-id">ID</div>
              <div class="col-date">Tanggal</div>
              <div class="col-customer">Pelanggan</div>
              <div class="col-cashier">Kasir</div>
              <div class="col-total">Total</div>
              <div class="col-method">Metode</div>
              <div class="col-bank">Bank</div>
              <div class="col-receipt">Nota</div>
            </div>
            
            <div class="table-body" id="recentTableBody">
              <div class="transaction-card empty dashboard-grid">
                <span>Memuat data...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { apiService } from '../../lib/apiService';
    import feather from 'feather-icons';

    async function loadDashboard() {
      try {
        const data = await apiService.getAdminDashboard();
        const stats = data?.stats || { total_customers: 0, total_products: 0, total_orders: 0 };
        const transactions = data?.transactions || [];

        // Update Stats
        const tc = document.getElementById('totalCustomers');
        if (tc) tc.innerText = stats.total_customers || 0;
        const tp = document.getElementById('totalProducts');
        if (tp) tp.innerText = stats.total_products || 0;
        const to = document.getElementById('totalOrders');
        if (to) to.innerText = stats.total_orders || 0;

        // Update Table
        const container = document.getElementById('recentTableBody');
        if (container) {
          if (transactions.length === 0) {
            container.innerHTML = `<div class="transaction-card empty dashboard-grid"><span>Belum ada transaksi terakhir</span></div>`;
          } else {
            container.innerHTML = transactions.map((tr: any) => `
              <div class="transaction-card dashboard-grid">
                <div class="col-id">#${tr.id}</div>
                <div class="col-date">${new Date(tr.tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
                <div class="col-customer">${tr.pelanggan || '-'}</div>
                <div class="col-cashier">${tr.kasir || '-'}</div>
                <div class="col-total">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(Number(tr.total || 0))}</div>
                <div class="col-method">${tr.metode_pembayaran || '-'}</div>
                <div class="col-bank">${tr.bank || '-'}</div>
                <div class="col-receipt">${tr.nomor_nota || '-'}</div>
              </div>
            `).join('');
          }
        }
        
        // Re-init icons
        feather.replace();
      } catch (err) {
        console.error(err);
      }
    }

    loadDashboard();
  </script>
</Layout>
