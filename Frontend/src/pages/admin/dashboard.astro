---
// Admin Dashboard
import Layout from '../../layouts/Layout.astro';
import { apiService } from '../../lib/apiService';
import '../../css/admin.css';

const dashboardData = await apiService.getAdminDashboard();
const stats = dashboardData?.stats || { total_customers: 0, total_products: 0, total_orders: 0 };
---

<Layout title="Admin Dashboard - TUKO" isAdmin={true}>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav class="admin-menu">
        <a href="/admin/dashboard" class="menu-item active">
          <span>Beranda</span>
        </a>
        <a href="/admin/transaksi" class="menu-item">
          <span>Transaksi</span>
        </a>
        <a href="/admin/kasir" class="menu-item">
          <span>Kasir</span>
        </a>
        <a href="/admin/user" class="menu-item">
          <span>Pengguna</span>
        </a>
        <a href="/admin/product" class="menu-item">
          <span>Produk</span>
        </a>
        <a href="/admin/kategori" class="menu-item">
          <span>Kategori</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="logout-btn">
          <span>Keluar</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <button class="mobile-admin-toggle" id="sidebarToggle">
        <i data-feather="menu"></i> Menu Admin
      </button>
      
      <div class="admin-header">
        <h1>Dashboard</h1>
      </div>

      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon"><i data-feather="users"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalCustomers">0</div>
            <div class="stat-label">Total Pelanggan</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i data-feather="shopping-cart"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalProducts">0</div>
            <div class="stat-label">Produk Terjual</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i data-feather="file-text"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalOrders">0</div>
            <div class="stat-label">Total Order</div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div class="reports-container">
        <h2 class="section-title">Buatlah query utuh yang di dalamnya mengandung subquery untuk menghasilkan informasi-informasi berikut</h2>
        <div class="reports-grid" id="reportsGrid">
          <!-- Reports will be injected here -->
          <p>Memuat laporan...</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { apiService } from '../../lib/apiService.js';
    import feather from 'feather-icons';

    async function loadDashboard() {
      // Sidebar Toggle for Mobile
      const sidebarToggle = document.getElementById('sidebarToggle');
      const sidebar = document.querySelector('.admin-sidebar');
      
      if (sidebarToggle && sidebar) {
        sidebarToggle.addEventListener('click', () => {
          sidebar.classList.toggle('active');
        });
      }

      try {
        const data = await apiService.getAdminDashboard();
        const stats = data?.stats || { total_customers: 0, total_products: 0, total_orders: 0 };

        // Update Stats
        const tc = document.getElementById('totalCustomers');
        if (tc) tc.innerText = (stats as any).totalCustomers || stats.total_customers || 0;
        const tp = document.getElementById('totalProducts');
        if (tp) tp.innerText = (stats as any).totalProductsSold || stats.total_products || 0;
        const to = document.getElementById('totalOrders');
        if (to) to.innerText = stats.total_orders || 0;
        
        // Load Reports
        const reports = await apiService.getDashboardReports();
        renderReports(reports);

        // Re-init icons
        feather.replace();
      } catch (err) {
        console.error(err);
      }
    }

    function renderReports(reports: any) {
      const grid = document.getElementById('reportsGrid');
      if (!grid) return;

      if (!Array.isArray(reports) || reports.length === 0) {
        grid.innerHTML = '<p>Tidak ada data laporan untuk tahun sebelumnya.</p>';
        return;
      }

      // Fallback titles if API doesn't provide them
      const fallbackTitles = [
        "1. Produk yang paling banyak dibeli beserta jumlahnya pada tahun sebelumnya",
        "2. Siapa saja yang paling banyak melakukan order beserta jumlahnya pada tahun sebelumnya",
        "3. Siapa saja yang paling besar nilai ordenya beserta nominalnya pada tahun sebelumnya",
        "4. Siapa saja yang jumlah item produk ordernya paling banyak beserta jumlahnya pada tahun sebelumnya",
        "5. 10 produk terlaris beserta jumlahnya pada tahun sebelumnya",
        "6. tampilan profit penjualan bulanan di tahun sebelumnya untuk setiap produk",
        "7. tampilan jumlah penjualan bulanan di tahun sebelumnya untuk setiap produk",
        "8. tampilan jumlah order bulanan di tahun sebelumnya untuk setiap customer",
        "9. tampilan total nominal order bulanan di tahun sebelumnya untuk setiap customer",
        "10. tampilan jumlah layanan bulanan di tahun sebelumnya untuk setiap kasir"
      ];

      grid.innerHTML = reports.map((report: any, index: number) => {
        const data = report.data || [];
        const title = report.title || fallbackTitles[index] || "Laporan";
        
        // Get headers from first entry
        const headers = data.length > 0 ? Object.keys(data[0]) : [];
        
        return `
          <div class="report-card">
            <h3>${title}</h3>
            <div class="report-table-wrapper">
              <table>
                <thead>
                  <tr>
                    ${headers.map(h => `<th>${h.replace(/_/g, ' ')}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${data.length > 0 ? data.map((row: any) => `
                    <tr>
                      ${headers.map(h => {
                        let val = row[h];
                        const keyLower = h.toLowerCase();
                        // Format as currency ONLY for profit or nominal values
                        if (keyLower.includes('profit') || keyLower.includes('nominal')) {
                          const numVal = Number(val);
                          if (!isNaN(numVal)) {
                             val = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(numVal);
                          }
                        }
                        return `<td>${val}</td>`;
                      }).join('')}
                    </tr>
                  `).join('') : '<tr><td colspan="100%">Tidak ada data</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');
    }

    loadDashboard();
  </script>
</Layout>
