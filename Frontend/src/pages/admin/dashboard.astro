---
// Admin Dashboard
import Layout from '../../layouts/Layout.astro';
import { apiService } from '../../lib/apiService';
import '../../css/admin.css';

const dashboardData = await apiService.getAdminDashboard();
const stats = dashboardData?.stats || { total_customers: 0, total_products: 0, total_orders: 0 };
---

<Layout title="Admin Dashboard - TUKO" isAdmin={true}>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav class="admin-menu">
        <a href="/admin/dashboard" class="menu-item active">
          <span>Beranda</span>
        </a>
        <a href="/admin/transaksi" class="menu-item">
          <span>Transaksi</span>
        </a>
        <a href="/admin/kasir" class="menu-item">
          <span>Kasir</span>
        </a>
        <a href="/admin/user" class="menu-item">
          <span>Pengguna</span>
        </a>
        <a href="/admin/product" class="menu-item">
          <span>Produk</span>
        </a>
        <a href="/admin/kategori" class="menu-item">
          <span>Kategori</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="logout-btn">
          <span>Keluar</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1>Dashboard</h1>
      </div>

      <!-- Stats Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon"><i data-feather="users"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalCustomers">0</div>
            <div class="stat-label">Total Pelanggan</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i data-feather="shopping-cart"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalProducts">0</div>
            <div class="stat-label">Produk Terjual</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon"><i data-feather="file-text"></i></div>
          <div class="stat-info">
            <div class="stat-number" id="totalOrders">0</div>
            <div class="stat-label">Total Order</div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div class="reports-container">
        <h2 class="section-title">Buatlah query utuh yang di dalamnya mengandung subquery untuk menghasilkan informasi-informasi berikut</h2>
        <div class="reports-grid" id="reportsGrid">
          <!-- Reports will be injected here -->
          <p>Memuat laporan...</p>
        </div>
      </div>
    </main>
  </div>

  <script>
    import { apiService } from '../../lib/apiService.js';
    import feather from 'feather-icons';

    async function loadDashboard() {
      try {
        const data = await apiService.getAdminDashboard();
        const stats = data?.stats || { total_customers: 0, total_products: 0, total_orders: 0 };

        // Update Stats
        const tc = document.getElementById('totalCustomers');
        if (tc) tc.innerText = (stats as any).totalCustomers || stats.total_customers || 0;
        const tp = document.getElementById('totalProducts');
        if (tp) tp.innerText = (stats as any).totalProductsSold || stats.total_products || 0;
        const to = document.getElementById('totalOrders');
        if (to) to.innerText = stats.total_orders || 0;
        
        // Load Reports
        const reports = await apiService.getDashboardReports();
        renderReports(reports);

        // Re-init icons
        feather.replace();
      } catch (err) {
        console.error(err);
      }
    }

    function renderReports(reports: any) {
      const grid = document.getElementById('reportsGrid');
      if (!grid) return;

      if (!Array.isArray(reports) || reports.length === 0) {
        grid.innerHTML = '<p>Tidak ada data laporan untuk tahun sebelumnya.</p>';
        return;
      }

      grid.innerHTML = reports.map((report: any) => {
        const data = report.data || [];
        const title = report.title || "Laporan";
        
        // Get headers from first entry
        const headers = data.length > 0 ? Object.keys(data[0]) : [];
        
        return `
          <div class="report-card">
            <h3>${title}</h3>
            <div class="report-table-wrapper">
              <table>
                <thead>
                  <tr>
                    ${headers.map(h => `<th>${h.replace(/_/g, ' ')}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${data.length > 0 ? data.map((row: any) => `
                    <tr>
                      ${headers.map(h => {
                        let val = row[h];
                        const keyLower = h.toLowerCase();
                        if (keyLower.includes('total') || keyLower.includes('profit') || keyLower.includes('nominal')) {
                          const numVal = Number(val);
                          if (!isNaN(numVal)) {
                             val = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(numVal);
                          }
                        }
                        return `<td>${val}</td>`;
                      }).join('')}
                    </tr>
                  `).join('') : '<tr><td colspan="100%">Tidak ada data</td></tr>'}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');
    }

    loadDashboard();
  </script>
</Layout>
