---
// Admin Cashiers (Kasir)
import Layout from '../../layouts/Layout.astro';
import { apiService } from '../../lib/apiService';
import '../../css/admin.css';

const cashiers = await apiService.getAdminCashiers() as any[];
---

<Layout title="Data Kasir - TUKO Admin" isAdmin={true}>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <nav class="admin-menu">
        <a href="/admin/dashboard" class="menu-item">
          <span>Beranda</span>
        </a>
        <a href="/admin/transaksi" class="menu-item">
          <span>Transaksi</span>
        </a>
        <a href="/admin/kasir" class="menu-item active">
          <span>Kasir</span>
        </a>
        <a href="/admin/user" class="menu-item">
          <span>Pengguna</span>
        </a>
        <a href="/admin/product" class="menu-item">
          <span>Produk</span>
        </a>
        <a href="/admin/kategori" class="menu-item">
          <span>Kategori</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="logout-btn">
          <span>Keluar</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1>Data Kasir</h1>
        <button class="btn-baru" onclick="openKasirModal()">Baru</button>
      </div>

      <div class="transactions-section">
        <div class="table-scroll-wrapper">
          <div class="table-container">
            <div class="table-header kasir-grid">
              <div class="col-id">ID</div>
              <div class="col-username">Username</div>
              <div class="col-address">Alamat</div>
              <div class="col-pob">Tempat Lahir</div>
              <div class="col-dob">Tgl Lahir</div>
              <div class="col-contact">Kontak</div>
              <div class="col-email">Email</div>
              <div class="col-gender">Gender</div>
            </div>
            
            <div class="table-body" id="kasirTableBody">
              {/* Data will be loaded via client-side script */}
              <div class="transaction-card empty kasir-grid">
                <span>Memuat data...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Form -->
  <div id="kasirFormModal" class="modal">
    <div class="modal-content">
      <form id="kasirForm">
        <div class="form-row">
          <label for="kasirId">ID</label>
          <input type="text" id="kasirId" readonly />
        </div>

        <div class="form-row">
          <label for="username">Nama Pengguna</label>
          <input type="text" id="username" required />
        </div>

        <div class="form-row">
          <label for="address">Alamat</label>
          <input type="text" id="address" required />
        </div>

        <div class="form-row">
          <label for="pob">Tempat Lahir</label>
          <input type="text" id="pob" required />
        </div>

        <div class="form-row">
          <label for="dob">Tanggal Lahir</label>
          <input type="date" id="dob" required />
        </div>

        <div class="form-row">
          <label for="contact">Kontak</label>
          <input type="tel" id="contact" required />
        </div>

        <div class="form-row">
          <label for="email">Email</label>
          <input type="email" id="email" required />
        </div>

        <div class="form-row">
          <label for="gender">Jenis Kelamin</label>
          <select id="gender" required>
            <option value="L">Laki-Laki</option>
            <option value="P">Perempuan</option>
          </select>
        </div>

        <div class="form-actions-centered">
          <button type="submit" class="btn-green">Simpan</button>
          <button type="button" class="btn-red" id="deleteKasirBtn" onclick="deleteKasir()" disabled>Hapus</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    import { apiService } from '../../lib/apiService.js';

    let currentKasirId: string | null = null;
    let allCashiers: any[] = [];

    async function loadCashiers() {
      const container = document.getElementById('kasirTableBody');
      try {
        const data = await apiService.getAdminCashiers();
        allCashiers = data || [];
        
        if (!container) return;

        if (allCashiers.length === 0) {
          container.innerHTML = `
            <div class="transaction-card empty kasir-grid">
              <span>Belum ada data kasir</span>
            </div>
          `;
          return;
        }

        container.innerHTML = allCashiers.map((item: any) => `
          <div 
            class="transaction-card kasir-grid" 
            onclick="editKasir(event, '${item.USER_ID || item.user_id}')"
            style="cursor: pointer"
          >
            <div class="col-id">${item.USER_ID || item.user_id}</div>
            <div class="col-username">${item.USERNAME || item.username}</div>
            <div class="col-address">${item.ADDRESS || item.address || '-'}</div>
            <div class="col-pob">${item.PLACE_OF_BIRTH || item.place_of_birth || '-'}</div>
            <div class="col-dob">${(item.DATE_OF_BIRTH || item.date_of_birth) ? new Date(item.DATE_OF_BIRTH || item.date_of_birth).toLocaleDateString('id-ID') : '-'}</div>
            <div class="col-contact">${item.CONTACT_NUMBER || item.contact_number || '-'}</div>
            <div class="col-email">${item.EMAIL || item.email || '-'}</div>
            <div class="col-gender">${(item.GENDER_ID || item.gender_id) === 'L' ? 'Laki-Laki' : 'Perempuan'}</div>
          </div>
        `).join('');
      } catch (err) {
        if (container) container.innerHTML = '<div class="transaction-card empty"><span>Gagal memuat data</span></div>';
        console.error(err);
      }
    }

    function openKasirModal() {
      const modal = document.getElementById('kasirFormModal');
      const form = document.getElementById('kasirForm') as HTMLFormElement;
      const deleteBtn = document.getElementById('deleteKasirBtn') as HTMLButtonElement;
      
      currentKasirId = null;
      if (form) form.reset();
      (document.getElementById('kasirId') as HTMLInputElement).value = '';
      (document.getElementById('kasirId') as HTMLInputElement).readOnly = false;
      if (deleteBtn) deleteBtn.disabled = true;
      modal?.classList.add('active');
    }

    function closeKasirModal() {
      const modal = document.getElementById('kasirFormModal');
      modal?.classList.remove('active');
      const idInput = document.getElementById('kasirId') as HTMLInputElement;
      if (idInput) idInput.readOnly = true;
      currentKasirId = null;
    }

    function editKasir(event: any, userId: string) {
      if (event && event.stopPropagation) event.stopPropagation();
      
      const kasir = allCashiers.find(c => (c.USER_ID || c.user_id) === userId);
      if (!kasir) return;

      currentKasirId = kasir.USER_ID || kasir.user_id;
      const deleteBtn = document.getElementById('deleteKasirBtn') as HTMLButtonElement;
      
      (document.getElementById('kasirId') as HTMLInputElement).value = currentKasirId || '';
      (document.getElementById('kasirId') as HTMLInputElement).readOnly = true;
      (document.getElementById('username') as HTMLInputElement).value = kasir.USERNAME || kasir.username || '';
      (document.getElementById('address') as HTMLInputElement).value = kasir.ADDRESS || kasir.address || '';
      (document.getElementById('pob') as HTMLInputElement).value = kasir.PLACE_OF_BIRTH || kasir.place_of_birth || '';
      (document.getElementById('dob') as HTMLInputElement).value = (kasir.DATE_OF_BIRTH || kasir.date_of_birth) ? (kasir.DATE_OF_BIRTH || kasir.date_of_birth).split('T')[0] : '';
      (document.getElementById('contact') as HTMLInputElement).value = kasir.CONTACT_NUMBER || kasir.contact_number || '';
      (document.getElementById('email') as HTMLInputElement).value = kasir.EMAIL || kasir.email || '';
      (document.getElementById('gender') as HTMLSelectElement).value = kasir.GENDER_ID || kasir.gender_id || 'L';

      if (deleteBtn) deleteBtn.disabled = false;
      const modal = document.getElementById('kasirFormModal');
      modal?.classList.add('active');
    }

    async function deleteKasir() {
      if (!currentKasirId) {
        alert('Tidak ada data yang dipilih');
        return;
      }
      if (!confirm('Yakin ingin menghapus kasir ini?')) return;

      try {
        const res = await apiService.safeFetch(`/.netlify/functions/cashiers/${currentKasirId}`, {
          method: 'DELETE',
        });
        if (res && res.success !== false) {
          window.location.reload();
        } else {
          alert('Gagal menghapus data');
        }
      } catch (error) {
        console.error('Error deleting cashier:', error);
        alert('Terjadi kesalahan');
      }
    }

    const form = document.getElementById('kasirForm');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        user_id: (document.getElementById('kasirId') as HTMLInputElement).value,
        username: (document.getElementById('username') as HTMLInputElement).value,
        address: (document.getElementById('address') as HTMLInputElement).value,
        place_of_birth: (document.getElementById('pob') as HTMLInputElement).value,
        date_of_birth: (document.getElementById('dob') as HTMLInputElement).value,
        contact_number: (document.getElementById('contact') as HTMLInputElement).value,
        email: (document.getElementById('email') as HTMLInputElement).value,
        gender_id: (document.getElementById('gender') as HTMLSelectElement).value,
      };

      try {
        const url = `/.netlify/functions/cashiers${currentKasirId ? '/' + currentKasirId : ''}`;
        const method = currentKasirId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });

        if (response.ok) {
          closeKasirModal();
          window.location.reload();
        } else {
          alert('Gagal menyimpan data');
        }
      } catch (error) {
        console.error('Error saving cashier:', error);
        alert('Terjadi kesalahan');
      }
    });

    // Close modal when clicking outside
    const modal = document.getElementById('kasirFormModal');
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeKasirModal();
      }
    });

    // Global Init
    loadCashiers();

    // Expose functions to window
    (window as any).openKasirModal = openKasirModal;
    (window as any).closeKasirModal = closeKasirModal;
    (window as any).editKasir = editKasir;
    (window as any).deleteKasir = deleteKasir;
  </script>
</Layout>
</Layout>
