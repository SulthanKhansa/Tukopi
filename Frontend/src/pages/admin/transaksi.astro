---
// Admin Transaksi - Client Side Data Fetching
import Layout from '../../layouts/Layout.astro';
import '../../css/admin.css';
---

<Layout title="Data Transaksi - TUKO" isAdmin={true}>
  <div class="admin-container">
    <aside class="admin-sidebar">
      <nav class="admin-menu">
        <a href="/admin/dashboard" class="menu-item">
          <span>Beranda</span>
        </a>
        <a href="/admin/transaksi" class="menu-item active">
          <span>Transaksi</span>
        </a>
        <a href="/admin/kasir" class="menu-item">
          <span>Kasir</span>
        </a>
        <a href="/admin/user" class="menu-item">
          <span>Pengguna</span>
        </a>
        <a href="/admin/product" class="menu-item">
          <span>Produk</span>
        </a>
        <a href="/admin/kategori" class="menu-item">
          <span>Kategori</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <a href="/" class="logout-btn">
          <span>Keluar</span>
        </a>
      </div>
    </aside>

    <main class="admin-main">
      <div class="admin-header">
        <h1>Data Transaksi</h1>
        <button class="btn-baru" onclick="openTransactionModal()">Baru</button>
      </div>

      <div class="transactions-section">
        <div class="table-scroll-wrapper">
          <div class="table-container">
            <div class="table-header dashboard-grid">
              <div class="col-id">ID</div>
              <div class="col-date">Tanggal</div>
              <div class="col-customer">Pelanggan</div>
              <div class="col-cashier">Kasir</div>
              <div class="col-total">Total</div>
              <div class="col-method">Metode Pembayaran</div>
              <div class="col-bank">Bank</div>
              <div class="col-receipt">Nomor Nota</div>
            </div>
            
            <div id="table-body" class="table-body">
              <div class="transaction-card empty dashboard-grid">
                <span>Memuat data transaksi...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Form -->
  <div id="transactionFormModal" class="modal">
    <div class="modal-content">
      <form id="transactionForm">
        <div class="form-row">
          <label for="trId">ID</label>
          <input type="text" id="trId" readonly />
        </div>
        
        <div class="form-row">
          <label for="trTotal">Total Pembayaran (IDR)</label>
          <input type="number" id="trTotal" required />
        </div>

        <div class="form-row">
          <label for="trMethod">Metode Pembayaran</label>
          <select id="trMethod">
            <option value="1">CASH</option>
            <option value="2">QRIS</option>
            <option value="3">TRANSFER</option>
          </select>
        </div>

        <div class="form-row">
          <label for="trBank">Bank (Jika Transfer)</label>
          <input type="text" id="trBank" />
        </div>

        <div class="form-row">
          <label for="trReceipt">Nomor Nota / Referensi</label>
          <input type="text" id="trReceipt" />
        </div>

        <div class="form-actions-centered">
          <button type="submit" class="btn-green">Simpan</button>
          <button type="button" class="btn-red" id="deleteTransactionBtn" onclick="deleteTransaction()" disabled>Hapus</button>
          <button type="button" class="btn-gray" onclick="closeTransactionModal()">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    import { apiService } from '../../lib/apiService.js';

    let currentTrId: string | number | null = null;
    let transactions: any[] = [];

    async function loadTransactions() {
      const tableBody = document.getElementById('table-body');
      try {
        const data = await apiService.getAdminOrders();
        transactions = Array.isArray(data) ? data : [];

        if (tableBody) {
          if (transactions.length === 0) {
            tableBody.innerHTML = `
              <div class="transaction-card empty dashboard-grid">
                <span>Belum ada transaksi</span>
              </div>`;
          } else {
            tableBody.innerHTML = transactions.map((tr: any) => `
              <div 
                class="transaction-card dashboard-grid" 
                data-item='${JSON.stringify(tr).replace(/'/g, "&apos;")}'
                onclick='editTransaction(event)'
                style="cursor: pointer;"
              >
                <div class="col-id">#${tr.id}</div>
                <div class="col-date">
                  ${new Date(tr.tanggal).toLocaleDateString('id-ID', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                  })}
                </div>
                <div class="col-customer">${tr.pelanggan || '-'}</div>
                <div class="col-cashier">${tr.kasir || '-'}</div>
                <div class="col-total">
                  ${new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                  }).format(Number(tr.total || 0))}
                </div>
                <div class="col-method">${tr.metode_pembayaran || '-'}</div>
                <div class="col-bank">${tr.bank || '-'}</div>
                <div class="col-receipt">${tr.nomor_nota || '-'}</div>
              </div>
            `).join('');
          }
        }
      } catch (error) {
        console.error('Error loading transactions:', error);
        if (tableBody) {
          tableBody.innerHTML = '<div class="transaction-card empty dashboard-grid"><span>Gagal memuat data.</span></div>';
        }
      }
    }

    // Initialize
    loadTransactions();

    function openTransactionModal() {
      const modal = document.getElementById('transactionFormModal');
      const form = document.getElementById('transactionForm') as HTMLFormElement;
      const deleteBtn = document.getElementById('deleteTransactionBtn') as HTMLButtonElement;
      
      if (!modal || !form) return;

      currentTrId = null;
      form.reset();
      (document.getElementById('trId') as HTMLInputElement).value = '';
      (document.getElementById('trId') as HTMLInputElement).placeholder = 'Auto-Increment';
      if (deleteBtn) deleteBtn.disabled = true;
      modal.classList.add('active');
    }

    function closeTransactionModal() {
      const modal = document.getElementById('transactionFormModal');
      if (modal) {
        modal.classList.remove('active');
      }
      const trId = document.getElementById('trId') as HTMLInputElement;
      if (trId) trId.placeholder = '';
      currentTrId = null;
    }

    function editTransaction(event: any) {
      if (event && event.stopPropagation) event.stopPropagation();
      const datasetItem = event.currentTarget.dataset.item;
      if (!datasetItem) return;
      
      const tr = JSON.parse(datasetItem);
      currentTrId = tr.id;
      
      (document.getElementById('trId') as HTMLInputElement).value = tr.id;
      (document.getElementById('trTotal') as HTMLInputElement).value = tr.total;
      (document.getElementById('trMethod') as HTMLSelectElement).value = tr.method_id || '1';
      (document.getElementById('trBank') as HTMLInputElement).value = tr.bank || '';
      (document.getElementById('trReceipt') as HTMLInputElement).value = tr.nomor_nota || '';

      const deleteBtn = document.getElementById('deleteTransactionBtn') as HTMLButtonElement;
      if (deleteBtn) deleteBtn.disabled = false;

      const modal = document.getElementById('transactionFormModal');
      if (modal) modal.classList.add('active');
    }

    async function deleteTransaction() {
      if (!currentTrId) return;
      if (!confirm('Yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.')) return;

      try {
        const res = await apiService.deleteOrder(currentTrId);
        if (res && res.success !== false) {
          window.location.reload();
        } else {
          alert('Gagal menghapus: ' + (res?.message || 'Cek koneksi'));
        }
      } catch (err) {
        console.error(err);
        alert('Terjadi kesalahan');
      }
    }

    document.getElementById('transactionForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data: any = {
        total: parseInt((document.getElementById('trTotal') as HTMLInputElement).value),
        methodId: (document.getElementById('trMethod') as HTMLSelectElement).value,
        bank: (document.getElementById('trBank') as HTMLInputElement).value,
        receipt: (document.getElementById('trReceipt') as HTMLInputElement).value,
      };

      try {
        let res;
        if (currentTrId) {
          // Update
          res = await apiService.updateOrder(currentTrId, data);
        } else {
          // Create
          // Required for createOrder backend: { orderDate, custId, userId, methodId, total, items }
          const createData = {
            orderDate: new Date().toISOString().slice(0, 19).replace('T', ' '),
            custId: '-NoName-',
            userId: 'admin', // Or get current user
            methodId: data.methodId,
            total: data.total,
            items: [] // Manual entry has no items
          };
          res = await apiService.createOrder(createData);
        }

        if (res && res.success !== false) {
          window.location.reload();
        } else {
          alert('Gagal menyimpan: ' + (res?.message || 'Cek koneksi'));
        }
      } catch (err) {
        console.error(err);
        alert('Terjadi kesalahan');
      }
    });

    // Handle outside click
    const modal = document.getElementById('transactionFormModal');
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeTransactionModal();
    });

    // Globally expose
    (window as any).editTransaction = editTransaction;
    (window as any).openTransactionModal = openTransactionModal;
    (window as any).closeTransactionModal = closeTransactionModal;
    (window as any).deleteTransaction = deleteTransaction;
  </script>
</Layout>
